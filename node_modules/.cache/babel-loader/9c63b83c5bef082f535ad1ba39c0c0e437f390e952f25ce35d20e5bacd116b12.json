{"ast":null,"code":"import React,{useState,useEffect}from'react';import{Dialog,DialogTitle,DialogContent,DialogActions,Button,TextField,Box,CircularProgress}from'@mui/material';import{Star}from'lucide-react';import axios from'axios';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const ReviewDialog=_ref=>{let{open,onClose,bookId,currentUser,existingReview=null,onReviewSubmit}=_ref;const[reviewRating,setReviewRating]=useState(0);const[reviewText,setReviewText]=useState('');const[reviewHover,setReviewHover]=useState(0);const[loading,setLoading]=useState(false);const[initialReview,setInitialReview]=useState(null);const[hasChanges,setHasChanges]=useState(false);// Fetch user's review when dialog opens\nuseEffect(()=>{const fetchUserReview=async()=>{if(!currentUser||!open)return;try{const response=await axios.get(`http://localhost:8080/api/v1/review/user/${currentUser.userId}/book/${bookId}`,{headers:{Authorization:`Bearer ${localStorage.getItem('token')}`}});if(response.data.data&&response.data.data.length>0){const userReview=response.data.data[0];setInitialReview(userReview);setReviewRating(userReview.rating);setReviewText(userReview.review);}else{// No existing review\nsetInitialReview(null);setReviewRating(0);setReviewText('');}}catch(error){console.error('Error fetching user review:',error);}};fetchUserReview();},[open,currentUser,bookId]);// Check for changes\nuseEffect(()=>{if(!initialReview){// If no initial review, enable submit if form has content\nsetHasChanges(reviewRating>0&&reviewText.trim()!=='');return;}// Check if rating or text has changed from initial values\nconst ratingChanged=reviewRating!==initialReview.rating;const textChanged=reviewText!==initialReview.review;setHasChanges(ratingChanged||textChanged);},[reviewRating,reviewText,initialReview]);const handleSubmit=async()=>{try{setLoading(true);const reviewData={userId:currentUser.userId,bookId:bookId,rating:reviewRating,review:reviewText};if(initialReview){// Update existing review\nreviewData.reviewId=initialReview.reviewId;await axios.put('http://localhost:8080/api/v1/review',reviewData,{headers:{Authorization:`Bearer ${localStorage.getItem('token')}`}});}else{// Create new review\nawait axios.post('http://localhost:8080/api/v1/review',reviewData,{headers:{Authorization:`Bearer ${localStorage.getItem('token')}`}});}// Reset state\nsetHasChanges(false);onReviewSubmit();// Gọi hàm callback sau khi submit thành công\nonClose();}catch(error){console.error('Error submitting review:',error);}finally{setLoading(false);}};return/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:onClose,maxWidth:\"sm\",fullWidth:true,children:[/*#__PURE__*/_jsx(DialogTitle,{children:initialReview?'Update Your Review':'Write a Review'}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsx(Box,{sx:{display:'flex',justifyContent:'center',mb:3,gap:1},children:[1,2,3,4,5].map(star=>/*#__PURE__*/_jsx(Star,{size:32,className:`cursor-pointer transition-colors ${(reviewHover||reviewRating)>=star?'text-yellow-400 fill-yellow-400':'text-gray-300'}`,onMouseEnter:()=>setReviewHover(star),onMouseLeave:()=>setReviewHover(0),onClick:()=>setReviewRating(star)},star))}),/*#__PURE__*/_jsx(TextField,{fullWidth:true,multiline:true,rows:4,placeholder:\"Share your thoughts about this book\",variant:\"outlined\",value:reviewText,onChange:e=>setReviewText(e.target.value)})]}),/*#__PURE__*/_jsxs(DialogActions,{sx:{p:2,gap:1},children:[/*#__PURE__*/_jsx(Button,{onClick:onClose,variant:\"outlined\",children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:handleSubmit,disabled:!hasChanges||loading,children:loading?/*#__PURE__*/_jsx(CircularProgress,{size:24}):initialReview?'Update Review':'Submit Review'})]})]});};export default ReviewDialog;","map":{"version":3,"names":["React","useState","useEffect","Dialog","DialogTitle","DialogContent","DialogActions","Button","TextField","Box","CircularProgress","Star","axios","jsx","_jsx","jsxs","_jsxs","ReviewDialog","_ref","open","onClose","bookId","currentUser","existingReview","onReviewSubmit","reviewRating","setReviewRating","reviewText","setReviewText","reviewHover","setReviewHover","loading","setLoading","initialReview","setInitialReview","hasChanges","setHasChanges","fetchUserReview","response","get","userId","headers","Authorization","localStorage","getItem","data","length","userReview","rating","review","error","console","trim","ratingChanged","textChanged","handleSubmit","reviewData","reviewId","put","post","maxWidth","fullWidth","children","sx","display","justifyContent","mb","gap","map","star","size","className","onMouseEnter","onMouseLeave","onClick","multiline","rows","placeholder","variant","value","onChange","e","target","p","disabled"],"sources":["C:/Users/TTC/OneDrive/Documents/GITHUB/fe-readhub/src/pages/description_book/views/ReviewDialog.js"],"sourcesContent":["import React, {useState, useEffect} from 'react'\r\nimport {\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  DialogActions,\r\n  Button,\r\n  TextField,\r\n  Box,\r\n  CircularProgress,\r\n} from '@mui/material'\r\nimport {Star} from 'lucide-react'\r\nimport axios from 'axios'\r\n\r\nconst ReviewDialog = ({\r\n  open,\r\n  onClose,\r\n  bookId,\r\n  currentUser,\r\n  existingReview = null,\r\n  onReviewSubmit,\r\n}) => {\r\n  const [reviewRating, setReviewRating] = useState(0)\r\n  const [reviewText, setReviewText] = useState('')\r\n  const [reviewHover, setReviewHover] = useState(0)\r\n  const [loading, setLoading] = useState(false)\r\n  const [initialReview, setInitialReview] = useState(null)\r\n  const [hasChanges, setHasChanges] = useState(false)\r\n\r\n  // Fetch user's review when dialog opens\r\n  useEffect(() => {\r\n    const fetchUserReview = async () => {\r\n      if (!currentUser || !open) return\r\n\r\n      try {\r\n        const response = await axios.get(\r\n          `http://localhost:8080/api/v1/review/user/${currentUser.userId}/book/${bookId}`,\r\n          {\r\n            headers: {\r\n              Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n            },\r\n          },\r\n        )\r\n\r\n        if (response.data.data && response.data.data.length > 0) {\r\n          const userReview = response.data.data[0]\r\n          setInitialReview(userReview)\r\n          setReviewRating(userReview.rating)\r\n          setReviewText(userReview.review)\r\n        } else {\r\n          // No existing review\r\n          setInitialReview(null)\r\n          setReviewRating(0)\r\n          setReviewText('')\r\n        }\r\n      } catch (error) {\r\n        console.error('Error fetching user review:', error)\r\n      }\r\n    }\r\n\r\n    fetchUserReview()\r\n  }, [open, currentUser, bookId])\r\n\r\n  // Check for changes\r\n  useEffect(() => {\r\n    if (!initialReview) {\r\n      // If no initial review, enable submit if form has content\r\n      setHasChanges(reviewRating > 0 && reviewText.trim() !== '')\r\n      return\r\n    }\r\n\r\n    // Check if rating or text has changed from initial values\r\n    const ratingChanged = reviewRating !== initialReview.rating\r\n    const textChanged = reviewText !== initialReview.review\r\n    setHasChanges(ratingChanged || textChanged)\r\n  }, [reviewRating, reviewText, initialReview])\r\n\r\n  const handleSubmit = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const reviewData = {\r\n        userId: currentUser.userId,\r\n        bookId: bookId,\r\n        rating: reviewRating,\r\n        review: reviewText,\r\n      }\r\n\r\n      if (initialReview) {\r\n        // Update existing review\r\n        reviewData.reviewId = initialReview.reviewId\r\n        await axios.put('http://localhost:8080/api/v1/review', reviewData, {\r\n          headers: {\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        })\r\n      } else {\r\n        // Create new review\r\n        await axios.post('http://localhost:8080/api/v1/review', reviewData, {\r\n          headers: {\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        })\r\n      }\r\n\r\n      // Reset state\r\n      setHasChanges(false)\r\n      onReviewSubmit() // Gọi hàm callback sau khi submit thành công\r\n      onClose()\r\n    } catch (error) {\r\n      console.error('Error submitting review:', error)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onClose={onClose} maxWidth='sm' fullWidth>\r\n      <DialogTitle>\r\n        {initialReview ? 'Update Your Review' : 'Write a Review'}\r\n      </DialogTitle>\r\n\r\n      <DialogContent>\r\n        {/* Rating Stars */}\r\n        <Box\r\n          sx={{\r\n            display: 'flex',\r\n            justifyContent: 'center',\r\n            mb: 3,\r\n            gap: 1,\r\n          }}>\r\n          {[1, 2, 3, 4, 5].map(star => (\r\n            <Star\r\n              key={star}\r\n              size={32}\r\n              className={`cursor-pointer transition-colors ${\r\n                (reviewHover || reviewRating) >= star\r\n                  ? 'text-yellow-400 fill-yellow-400'\r\n                  : 'text-gray-300'\r\n              }`}\r\n              onMouseEnter={() => setReviewHover(star)}\r\n              onMouseLeave={() => setReviewHover(0)}\r\n              onClick={() => setReviewRating(star)}\r\n            />\r\n          ))}\r\n        </Box>\r\n\r\n        <TextField\r\n          fullWidth\r\n          multiline\r\n          rows={4}\r\n          placeholder='Share your thoughts about this book'\r\n          variant='outlined'\r\n          value={reviewText}\r\n          onChange={e => setReviewText(e.target.value)}\r\n        />\r\n      </DialogContent>\r\n\r\n      <DialogActions sx={{p: 2, gap: 1}}>\r\n        <Button onClick={onClose} variant='outlined'>\r\n          Cancel\r\n        </Button>\r\n        <Button\r\n          variant='contained'\r\n          onClick={handleSubmit}\r\n          disabled={!hasChanges || loading}>\r\n          {loading ? (\r\n            <CircularProgress size={24} />\r\n          ) : initialReview ? (\r\n            'Update Review'\r\n          ) : (\r\n            'Submit Review'\r\n          )}\r\n        </Button>\r\n      </DialogActions>\r\n    </Dialog>\r\n  )\r\n}\r\n\r\nexport default ReviewDialog\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}