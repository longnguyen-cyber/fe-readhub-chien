{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\TTC\\\\OneDrive\\\\Documents\\\\GITHUB\\\\fe-readhub\\\\src\\\\pages\\\\read_book\\\\views\\\\ReadBookScreen.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useState } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { ReactReaderStyle } from 'react-reader';\nimport ePub from 'epubjs';\nimport ReaderHeader from './ReaderHeader';\nimport ReaderContent from './ReaderContent';\nimport NotePopover from './NotePopover';\nimport NotesDrawer from './NotesDrawer';\nimport SettingsDrawer from './SettingsDrawer';\nimport { Button, Select, MenuItem, TextField, DialogActions, Dialog, DialogTitle, DialogContent } from '@mui/material';\nimport axios from 'axios';\nimport { toast } from 'react-toastify';\nimport 'react-toastify/dist/ReactToastify.css';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst colors = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF'];\nconst themes = ['#FFFFFF', '#faf6ed', '#121212'];\nconst fontFamilies = ['Times New Roman', 'Arial', 'Georgia', 'Verdana'];\nconst defaultSettings = {\n  theme: themes[0],\n  pageView: 'double',\n  fontFamily: fontFamilies[0],\n  fontSize: 16,\n  fontWeight: 400,\n  lineHeight: 1.2,\n  zoom: 100\n};\nfunction ReadBookScreen() {\n  _s();\n  var _selections$find, _selections$find2;\n  const navigate = useNavigate();\n  const location = useLocation();\n  const [loca, setLocation] = useState(location || '');\n  const {\n    bookId,\n    bookTitle\n  } = location.state || {};\n  const [error, setError] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [epubUrl, setEpubUrl] = useState(null);\n  const [selections, setSelections] = useState([]);\n  const [drawerOpen, setDrawerOpen] = useState(false);\n  const [rendition, setRendition] = useState(null);\n  const [highlightColor, setHighlightColor] = useState(colors[0]);\n  const [comment, setComment] = useState('');\n  const [popoverAnchor, setPopoverAnchor] = useState(null);\n  const [selectedText, setSelectedText] = useState('');\n  const [selectedCfiRange, setSelectedCfiRange] = useState('');\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filter, setFilter] = useState('all');\n  const [editingNote, setEditingNote] = useState(null);\n  const [settingsDrawerOpen, setSettingsDrawerOpen] = useState(false);\n  const [settings, setSettings] = useState(defaultSettings);\n  const [user, setUser] = useState(null);\n  const [isNote, setIsNote] = useState(false);\n  const [hasBookmark, setHasBookmark] = useState(false);\n  const [currentLocation, setCurrentLocation] = useState(null);\n  const [readStartTime, setReadStartTime] = useState(null);\n  const [bookmarkId, setBookmarkId] = useState(null);\n  const [lastReadingUpdate, setLastReadingUpdate] = useState(null);\n  const [isActive, setIsActive] = useState(true);\n  const [activeHighlights] = useState(new Set());\n  const startReadingSession = () => {\n    setReadStartTime(Date.now());\n  };\n  const updateReadingHistory = async () => {\n    const currentTime = Date.now();\n    const timeSpent = Math.floor((currentTime - lastReadingUpdate) / 1000);\n    if (!user || !bookId) return;\n    try {\n      await axios.post(`${process.env.REACT_APP_API_BASE_URL}/reading-history`, {\n        userId: user.userId,\n        bookId: bookId,\n        timeSpent: timeSpent\n      }, {\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      setLastReadingUpdate(currentTime);\n    } catch (error) {\n      console.error('Error updating reading history:', error);\n    }\n  };\n  const saveBookmark = async location => {\n    if (!user || !bookId) return;\n    try {\n      await axios.post(`${process.env.REACT_APP_API_BASE_URL}/bookmark`, {\n        userId: user.userId,\n        bookId: bookId,\n        location: loca\n      }, {\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      setHasBookmark(true);\n      toast.success('Đã lưu đánh dấu trang');\n    } catch (error) {\n      console.error('Error saving bookmark:', error);\n      toast.error('Có lỗi xảy ra khi lưu đánh dấu trang', 'error');\n    }\n  };\n  const getUser = async () => {\n    if (!localStorage.getItem('token')) return;\n    try {\n      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/user/profile`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      setUser(response.data);\n    } catch (error) {\n      console.error(error);\n    }\n  };\n  const getNotes = async () => {\n    if (!(user !== null && user !== void 0 && user.userId) || !bookId || !rendition) return;\n    try {\n      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/note/user/${user.userId}/book/${bookId}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      const notesData = Array.isArray(response.data.data) ? response.data.data : [];\n      setSelections(notesData);\n    } catch (error) {\n      console.error('Error fetching notes:', error);\n      setSelections([]);\n    }\n  };\n  const handleEditNote = note => {\n    setEditingNote(note);\n  };\n  const handleSaveEdit = async () => {\n    try {\n      await axios.put(`${process.env.REACT_APP_API_BASE_URL}/note`, editingNote, {\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      if (editingNote) {\n        setSelections(selections.map(s => s.cfiRange === editingNote.cfiRange ? editingNote : s));\n\n        // Xóa highlight cũ\n        rendition.annotations.remove(editingNote.cfiRange, 'highlight');\n        activeHighlights.delete(editingNote.cfiRange);\n\n        // Tạo highlight mới với màu đã cập nhật\n        rendition.annotations.add('highlight', editingNote.cfiRange, {}, null, 'hl', {\n          fill: editingNote.color,\n          'fill-opacity': '0.3',\n          'mix-blend-mode': 'multiply'\n        });\n        activeHighlights.add(editingNote.cfiRange);\n        setIsNote(!isNote);\n        setEditingNote(null); // Đóng dialog\n      }\n    } catch (error) {\n      console.error('Error updating note:', error);\n    }\n  };\n  const getBookmark = async () => {\n    if (!user || !bookId) return;\n    try {\n      const response = await axios.get(`${process.env.REACT_APP_API_BASE_URL}/bookmark/user/${user.userId}/book/${bookId}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      if (response.data.data) {\n        setHasBookmark(true);\n        setBookmarkId(response.data.data.bookmarkId);\n        setLocation(response.data.data.location);\n      }\n    } catch (error) {\n      console.error('Error fetching bookmark:', error);\n    }\n  };\n  const handleToggleBookmark = async () => {\n    if (!user || !bookId) return;\n    if (hasBookmark && bookmarkId) {\n      try {\n        await axios.put(`${process.env.REACT_APP_API_BASE_URL}/bookmark`, {\n          bookmarkId: bookmarkId,\n          userId: user.userId,\n          bookId: bookId,\n          location: loca\n        }, {\n          headers: {\n            'Content-Type': 'application/json',\n            Authorization: `Bearer ${localStorage.getItem('token')}`\n          }\n        });\n        toast.success('Đã đánh dấu trang');\n      } catch (error) {\n        toast.error('Có lỗi xảy ra khi đánh dấu trang', 'error');\n      }\n    } else {\n      await saveBookmark(currentLocation);\n    }\n  };\n  const handleError = error => {\n    console.error('Error in ReactReader:', error);\n    setError('An error occurred while loading the book. Please try again later.');\n    setLoading(false);\n  };\n  const handleToggleDrawer = () => {\n    setDrawerOpen(!drawerOpen);\n  };\n  const handleSettingsDrawerToggle = () => {\n    setSettingsDrawerOpen(!settingsDrawerOpen);\n  };\n  const applySettings = () => {\n    if (rendition) {\n      // Xóa toàn bộ highlight hiện tại trước\n      activeHighlights.forEach(cfiRange => {\n        rendition.annotations.remove(cfiRange, 'highlight');\n      });\n      activeHighlights.clear();\n\n      // Apply settings mới\n      rendition.themes.default({\n        body: {\n          background: settings.theme,\n          color: settings.theme === '#121212' ? '#FFFFFF' : '#000000',\n          'font-family': settings.fontFamily === 'Default' ? 'inherit' : settings.fontFamily,\n          'font-size': `${settings.fontSize}px`,\n          'font-weight': settings.fontWeight,\n          'line-height': settings.lineHeight,\n          transform: `scale(${settings.zoom / 100})`,\n          'transform-origin': 'top left'\n        },\n        'a, a:link, a:visited, a:hover, a:active': {\n          color: 'inherit !important',\n          '-webkit-text-fill-color': 'inherit !important',\n          'text-decoration': 'none'\n        },\n        '::selection': {\n          'background-color': 'rgba(0, 0, 255, 0.1)',\n          color: 'inherit'\n        },\n        '*': {\n          transition: 'none !important'\n        }\n      });\n      rendition.themes.select('default');\n      if (settings.pageView === 'double') {\n        rendition.spread('auto');\n      } else {\n        rendition.spread('none');\n      }\n\n      // Apply lại highlight sau khi settings đã được cập nhật\n      setTimeout(() => {\n        selections.forEach(note => {\n          rendition.annotations.add('highlight', note.cfiRange, {}, null, 'hl', {\n            fill: note.color,\n            'fill-opacity': '0.3',\n            'mix-blend-mode': 'multiply'\n          });\n          activeHighlights.add(note.cfiRange);\n        });\n      }, 50);\n    }\n  };\n  const updateSettings = (key, value) => {\n    setSettings(prev => ({\n      ...prev,\n      [key]: value\n    }));\n    if (['fontSize', 'fontWeight', 'lineHeight', 'zoom'].includes(key)) {\n      rendition.clear();\n      rendition.themes.default({\n        body: {\n          background: settings.theme,\n          color: settings.theme === '#121212' ? '#FFFFFF' : '#000000',\n          'font-family': settings.fontFamily,\n          'font-size': `${value}px`,\n          'font-weight': key === 'fontWeight' ? value : settings.fontWeight,\n          'line-height': key === 'lineHeight' ? value : settings.lineHeight,\n          transform: key === 'zoom' ? `scale(${value / 100})` : `scale(${settings.zoom / 100})`,\n          'transform-origin': 'top left'\n        }\n      });\n      rendition.display(loca);\n    }\n  };\n  const handleResetSettings = () => {\n    setSettings(defaultSettings);\n  };\n\n  // Event Listeners and Effect Hooks\n  useEffect(() => {\n    applySettings();\n  }, [settings]);\n  useEffect(() => {\n    if (user !== null && user !== void 0 && user.userId && bookId) {\n      setLastReadingUpdate(Date.now());\n      setIsActive(true);\n      const intervalId = setInterval(() => {\n        if (isActive) {\n          updateReadingHistory();\n        }\n      }, 5 * 60 * 1000);\n      return () => {\n        updateReadingHistory();\n        clearInterval(intervalId);\n      };\n    }\n  }, [user, bookId]);\n  useEffect(() => {\n    const handleVisibilityChange = () => {\n      if (document.hidden) {\n        setIsActive(false);\n        updateReadingHistory();\n      } else {\n        setIsActive(true);\n        setLastReadingUpdate(Date.now());\n      }\n    };\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    return () => {\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n    };\n  }, []);\n  useEffect(() => {\n    const epubUrl = `https://www.gutenberg.org/cache/epub/${bookId}/pg${bookId}.epub`;\n    setEpubUrl(epubUrl);\n    getUser();\n  }, [bookId]);\n  useEffect(() => {\n    const handleBeforeUnload = () => {\n      updateReadingHistory();\n    };\n    window.addEventListener('beforeunload', handleBeforeUnload);\n    return () => {\n      window.removeEventListener('beforeunload', handleBeforeUnload);\n    };\n  }, []);\n  useEffect(() => {\n    if (user && bookId) {\n      getBookmark();\n    }\n  }, [user && bookId]);\n  useEffect(() => {\n    if (user && bookId) {\n      getNotes();\n    }\n  }, [user, bookId, rendition, isNote]);\n  useEffect(() => {\n    if (rendition) {\n      const handleSelection = (cfiRange, contents) => {\n        const selection = contents.window.getSelection();\n        const text = selection.toString().trim(); // Lấy text và trim luôn\n\n        // Chỉ xử lý khi có text thật sự\n        if (text) {\n          const range = selection.getRangeAt(0);\n          setSelectedText(text);\n          setSelectedCfiRange(cfiRange);\n          const rect = range.getBoundingClientRect();\n          const viewportHeight = window.innerHeight;\n          const viewportWidth = window.innerWidth;\n          setPopoverAnchor({\n            top: rect.top < viewportHeight / 2 ? rect.bottom + window.scrollY + 115 : rect.top + window.scrollY - 60,\n            left: viewportWidth / 2 + 5\n          });\n        }\n      };\n      rendition.on('selected', handleSelection);\n      rendition.themes.default({\n        '::selection': {\n          background: 'rgba(0, 0, 255, 0.1)',\n          color: 'inherit'\n        },\n        'a:link': {\n          color: 'inherit !important',\n          '-webkit-text-fill-color': 'inherit !important'\n        },\n        'a:hover': {\n          color: 'inherit !important',\n          '-webkit-text-fill-color': 'inherit !important'\n        }\n      });\n      return () => {\n        rendition.off('selected', handleSelection);\n      };\n    }\n  }, [rendition]);\n\n  // Highlight Management\n  useEffect(() => {\n    if (rendition) {\n      const applyHighlight = note => {\n        if (!activeHighlights.has(note.cfiRange)) {\n          rendition.annotations.add('highlight', note.cfiRange, {}, null, 'hl', {\n            fill: note.color,\n            'fill-opacity': '0.3',\n            'mix-blend-mode': 'multiply',\n            'white-space': 'pre-wrap',\n            // Giữ nguyên khoảng trắng\n            'box-decoration-break': 'clone' // Đảm bảo highlight không vượt quá text\n          });\n          activeHighlights.add(note.cfiRange);\n        }\n      };\n      const removeHighlight = cfiRange => {\n        rendition.annotations.remove(cfiRange, 'highlight');\n        activeHighlights.delete(cfiRange);\n      };\n      const refreshHighlights = () => {\n        // Xóa những highlight không còn trong selections\n        for (const cfiRange of activeHighlights) {\n          if (!selections.some(note => note.cfiRange === cfiRange)) {\n            removeHighlight(cfiRange);\n          }\n        }\n\n        // Thêm những highlight mới\n        selections.forEach(note => {\n          if (!activeHighlights.has(note.cfiRange)) {\n            applyHighlight(note);\n          }\n        });\n      };\n      refreshHighlights();\n\n      // Handler cho việc di chuyển trang\n      const handleRelocated = () => {\n        selections.forEach(note => {\n          if (!activeHighlights.has(note.cfiRange)) {\n            applyHighlight(note);\n          }\n        });\n      };\n      rendition.on('relocated', handleRelocated);\n      return () => {\n        rendition.off('relocated', handleRelocated);\n        // Không xóa highlights khi unmount để tránh việc phải render lại\n      };\n    }\n  }, [rendition, selections]);\n  const handleSave = async () => {\n    if (selectedCfiRange) {\n      const newNote = {\n        userId: user.userId,\n        bookId: bookId,\n        content: comment || '',\n        selectedText: selectedText,\n        cfiRange: selectedCfiRange,\n        color: highlightColor\n      };\n      try {\n        const response = await axios.post(`${process.env.REACT_APP_API_BASE_URL}/note`, newNote, {\n          headers: {\n            'Content-Type': 'application/json',\n            Authorization: `Bearer ${localStorage.getItem('token')}`\n          }\n        });\n        const createdNote = response.data;\n        setSelections(prev => [...prev, createdNote]);\n        setPopoverAnchor(null);\n        setComment('');\n        setSelectedText('');\n        setSelectedCfiRange('');\n        setIsNote(!isNote);\n      } catch (error) {\n        console.error('Error creating note:', error);\n      }\n    }\n  };\n  const handleRemoveHighlight = async (cfiRange, noteId) => {\n    try {\n      await axios.delete(`${process.env.REACT_APP_API_BASE_URL}/note/${noteId}`, {\n        headers: {\n          Authorization: `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      // Xóa highlight cụ thể\n      rendition.annotations.remove(cfiRange, 'highlight');\n      activeHighlights.delete(cfiRange);\n\n      // Cập nhật state\n      setSelections(selections.filter(s => s.cfiRange !== cfiRange));\n    } catch (error) {\n      console.error('Error deleting note:', error);\n    }\n  };\n  const filteredSelections = Array.isArray(selections) ? selections.filter(selection => {\n    var _selection$selectedTe, _selection$selectedTe2, _selection$content$to, _selection$content;\n    const isTextMatch = ((_selection$selectedTe = (_selection$selectedTe2 = selection.selectedText) === null || _selection$selectedTe2 === void 0 ? void 0 : _selection$selectedTe2.toLowerCase().includes(searchTerm.toLowerCase())) !== null && _selection$selectedTe !== void 0 ? _selection$selectedTe : false) || ((_selection$content$to = (_selection$content = selection.content) === null || _selection$content === void 0 ? void 0 : _selection$content.toLowerCase().includes(searchTerm.toLowerCase())) !== null && _selection$content$to !== void 0 ? _selection$content$to : false);\n    const isColorMatch = filter === 'all' || selection.color === filter;\n    return isTextMatch && isColorMatch;\n  }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)) : [];\n  const readerStyles = {\n    ...ReactReaderStyle,\n    readerArea: {\n      ...ReactReaderStyle.readerArea,\n      backgroundColor: settings.theme,\n      color: settings.theme === '#121212' ? '#FFFFFF' : '#000000'\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"App\",\n    style: {\n      height: '100vh',\n      display: 'flex',\n      flexDirection: 'column'\n    },\n    children: [/*#__PURE__*/_jsxDEV(ReaderHeader, {\n      title: bookTitle,\n      onBack: () => navigate(-1),\n      onToggleNotes: handleToggleDrawer,\n      onToggleSettings: handleSettingsDrawerToggle,\n      user: user,\n      onToggleBookmark: handleToggleBookmark,\n      hasBookmark: hasBookmark,\n      currentLocation: currentLocation\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 636,\n      columnNumber: 7\n    }, this), loading && /*#__PURE__*/_jsxDEV(\"p\", {\n      children: \"Loading...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 647,\n      columnNumber: 19\n    }, this), error && /*#__PURE__*/_jsxDEV(\"p\", {\n      style: {\n        color: 'red'\n      },\n      children: error\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 648,\n      columnNumber: 17\n    }, this), /*#__PURE__*/_jsxDEV(ReaderContent, {\n      epubUrl: epubUrl,\n      location: loca,\n      onLocationChanged: loc => setLocation(loc),\n      onGetRendition: _rendition => {\n        setRendition(_rendition);\n\n        // Apply default settings ngay khi rendition được tạo\n        _rendition.themes.default({\n          body: {\n            background: defaultSettings.theme,\n            color: defaultSettings.theme === '#121212' ? '#FFFFFF' : '#000000',\n            'font-family': defaultSettings.fontFamily,\n            'font-size': `${defaultSettings.fontSize}px`,\n            'font-weight': defaultSettings.fontWeight,\n            'line-height': defaultSettings.lineHeight,\n            transform: `scale(${defaultSettings.zoom / 100})`,\n            'transform-origin': 'top left'\n          },\n          'a, a:link, a:visited, a:hover, a:active': {\n            color: 'inherit !important',\n            '-webkit-text-fill-color': 'inherit !important',\n            'text-decoration': 'none'\n          },\n          '::selection': {\n            'background-color': 'rgba(0, 0, 255, 0.1)',\n            color: 'inherit'\n          },\n          '*': {\n            transition: 'none !important'\n          }\n        });\n        _rendition.themes.select('default');\n        if (defaultSettings.pageView === 'double') {\n          _rendition.spread('auto');\n        } else {\n          _rendition.spread('none');\n        }\n        _rendition.on('started', () => setLoading(false));\n      },\n      onError: handleError,\n      readerStyles: readerStyles\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 650,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(NotePopover, {\n      anchorPosition: popoverAnchor,\n      open: Boolean(popoverAnchor),\n      onClose: () => setPopoverAnchor(null),\n      colors: colors,\n      highlightColor: highlightColor,\n      setHighlightColor: setHighlightColor,\n      comment: comment,\n      setComment: setComment,\n      onSave: handleSave\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 697,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(NotesDrawer, {\n      open: drawerOpen,\n      onClose: handleToggleDrawer,\n      searchTerm: searchTerm,\n      setSearchTerm: setSearchTerm,\n      filter: filter,\n      setFilter: setFilter,\n      colors: colors,\n      filteredSelections: filteredSelections,\n      rendition: rendition,\n      onRemoveHighlight: handleRemoveHighlight,\n      onEditNote: handleEditNote\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 709,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Dialog, {\n      open: Boolean(editingNote),\n      onClose: () => setEditingNote(null),\n      children: [/*#__PURE__*/_jsxDEV(DialogTitle, {\n        children: \"Edit Note\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 724,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(DialogContent, {\n        children: [/*#__PURE__*/_jsxDEV(TextField, {\n          autoFocus: true,\n          margin: \"dense\",\n          label: \"Comment\",\n          fullWidth: true,\n          multiline: true,\n          rows: 4,\n          value: (editingNote === null || editingNote === void 0 ? void 0 : editingNote.content) || '',\n          onChange: e => setEditingNote({\n            ...editingNote,\n            content: e.target.value\n          })\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 726,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(Select, {\n          value: (editingNote === null || editingNote === void 0 ? void 0 : editingNote.color) || colors[0],\n          onChange: e => setEditingNote({\n            ...editingNote,\n            color: e.target.value\n          }),\n          fullWidth: true,\n          style: {\n            marginTop: '10px'\n          },\n          children: colors.map((color, index) => /*#__PURE__*/_jsxDEV(MenuItem, {\n            value: color,\n            children: /*#__PURE__*/_jsxDEV(\"span\", {\n              style: {\n                backgroundColor: color,\n                padding: '2px 10px',\n                borderRadius: '5px',\n                color: color\n              },\n              children: `ColorColorColorColorColorColori`\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 747,\n              columnNumber: 17\n            }, this)\n          }, index, false, {\n            fileName: _jsxFileName,\n            lineNumber: 746,\n            columnNumber: 15\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 738,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 725,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(DialogActions, {\n        children: [/*#__PURE__*/_jsxDEV(Button, {\n          onClick: () => setEditingNote(null),\n          children: \"Cancel\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 761,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          color: \"primary\",\n          variant: \"contained\",\n          disabled: !editingNote || ((_selections$find = selections.find(note => note.noteId === editingNote.noteId)) === null || _selections$find === void 0 ? void 0 : _selections$find.content) === editingNote.content && ((_selections$find2 = selections.find(note => note.noteId === editingNote.noteId)) === null || _selections$find2 === void 0 ? void 0 : _selections$find2.color) === editingNote.color,\n          onClick: handleSaveEdit,\n          children: \"Save\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 762,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 760,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 723,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(SettingsDrawer, {\n      open: settingsDrawerOpen,\n      onClose: handleSettingsDrawerToggle,\n      settings: settings,\n      updateSettings: updateSettings,\n      themes: themes,\n      fontFamilies: fontFamilies,\n      onResetSettings: handleResetSettings\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 778,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 633,\n    columnNumber: 5\n  }, this);\n}\n_s(ReadBookScreen, \"uPxyoo+QLEZVNX53F5z97b2Bpyw=\", false, function () {\n  return [useNavigate, useLocation];\n});\n_c = ReadBookScreen;\nexport default ReadBookScreen;\nvar _c;\n$RefreshReg$(_c, \"ReadBookScreen\");","map":{"version":3,"names":["React","useEffect","useState","useLocation","useNavigate","ReactReaderStyle","ePub","ReaderHeader","ReaderContent","NotePopover","NotesDrawer","SettingsDrawer","Button","Select","MenuItem","TextField","DialogActions","Dialog","DialogTitle","DialogContent","axios","toast","jsxDEV","_jsxDEV","colors","themes","fontFamilies","defaultSettings","theme","pageView","fontFamily","fontSize","fontWeight","lineHeight","zoom","ReadBookScreen","_s","_selections$find","_selections$find2","navigate","location","loca","setLocation","bookId","bookTitle","state","error","setError","loading","setLoading","epubUrl","setEpubUrl","selections","setSelections","drawerOpen","setDrawerOpen","rendition","setRendition","highlightColor","setHighlightColor","comment","setComment","popoverAnchor","setPopoverAnchor","selectedText","setSelectedText","selectedCfiRange","setSelectedCfiRange","searchTerm","setSearchTerm","filter","setFilter","editingNote","setEditingNote","settingsDrawerOpen","setSettingsDrawerOpen","settings","setSettings","user","setUser","isNote","setIsNote","hasBookmark","setHasBookmark","currentLocation","setCurrentLocation","readStartTime","setReadStartTime","bookmarkId","setBookmarkId","lastReadingUpdate","setLastReadingUpdate","isActive","setIsActive","activeHighlights","Set","startReadingSession","Date","now","updateReadingHistory","currentTime","timeSpent","Math","floor","post","process","env","REACT_APP_API_BASE_URL","userId","headers","Authorization","localStorage","getItem","console","saveBookmark","success","getUser","response","get","data","getNotes","notesData","Array","isArray","handleEditNote","note","handleSaveEdit","put","map","s","cfiRange","annotations","remove","delete","add","fill","color","getBookmark","handleToggleBookmark","handleError","handleToggleDrawer","handleSettingsDrawerToggle","applySettings","forEach","clear","default","body","background","transform","transition","select","spread","setTimeout","updateSettings","key","value","prev","includes","display","handleResetSettings","intervalId","setInterval","clearInterval","handleVisibilityChange","document","hidden","addEventListener","removeEventListener","handleBeforeUnload","window","handleSelection","contents","selection","getSelection","text","toString","trim","range","getRangeAt","rect","getBoundingClientRect","viewportHeight","innerHeight","viewportWidth","innerWidth","top","bottom","scrollY","left","on","off","applyHighlight","has","removeHighlight","refreshHighlights","some","handleRelocated","handleSave","newNote","content","createdNote","handleRemoveHighlight","noteId","filteredSelections","_selection$selectedTe","_selection$selectedTe2","_selection$content$to","_selection$content","isTextMatch","toLowerCase","isColorMatch","sort","a","b","createdAt","readerStyles","readerArea","backgroundColor","className","style","height","flexDirection","children","title","onBack","onToggleNotes","onToggleSettings","onToggleBookmark","fileName","_jsxFileName","lineNumber","columnNumber","onLocationChanged","loc","onGetRendition","_rendition","onError","anchorPosition","open","Boolean","onClose","onSave","onRemoveHighlight","onEditNote","autoFocus","margin","label","fullWidth","multiline","rows","onChange","e","target","marginTop","index","padding","borderRadius","onClick","variant","disabled","find","onResetSettings","_c","$RefreshReg$"],"sources":["C:/Users/TTC/OneDrive/Documents/GITHUB/fe-readhub/src/pages/read_book/views/ReadBookScreen.js"],"sourcesContent":["import React, {useEffect, useState} from 'react'\r\nimport {useLocation, useNavigate} from 'react-router-dom'\r\nimport {ReactReaderStyle} from 'react-reader'\r\nimport ePub from 'epubjs'\r\nimport ReaderHeader from './ReaderHeader'\r\nimport ReaderContent from './ReaderContent'\r\nimport NotePopover from './NotePopover'\r\nimport NotesDrawer from './NotesDrawer'\r\nimport SettingsDrawer from './SettingsDrawer'\r\nimport {\r\n  Button,\r\n  Select,\r\n  MenuItem,\r\n  TextField,\r\n  DialogActions,\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n} from '@mui/material'\r\nimport axios from 'axios'\r\nimport {toast} from 'react-toastify'\r\nimport 'react-toastify/dist/ReactToastify.css'\r\n\r\nconst colors = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF']\r\nconst themes = ['#FFFFFF', '#faf6ed', '#121212']\r\nconst fontFamilies = ['Times New Roman', 'Arial', 'Georgia', 'Verdana']\r\nconst defaultSettings = {\r\n  theme: themes[0],\r\n  pageView: 'double',\r\n  fontFamily: fontFamilies[0],\r\n  fontSize: 16,\r\n  fontWeight: 400,\r\n  lineHeight: 1.2,\r\n  zoom: 100,\r\n}\r\n\r\nfunction ReadBookScreen() {\r\n  const navigate = useNavigate()\r\n  const location = useLocation()\r\n  const [loca, setLocation] = useState(location || '')\r\n  const {bookId, bookTitle} = location.state || {}\r\n  const [error, setError] = useState(null)\r\n  const [loading, setLoading] = useState(false)\r\n  const [epubUrl, setEpubUrl] = useState(null)\r\n  const [selections, setSelections] = useState([])\r\n  const [drawerOpen, setDrawerOpen] = useState(false)\r\n  const [rendition, setRendition] = useState(null)\r\n  const [highlightColor, setHighlightColor] = useState(colors[0])\r\n  const [comment, setComment] = useState('')\r\n  const [popoverAnchor, setPopoverAnchor] = useState(null)\r\n  const [selectedText, setSelectedText] = useState('')\r\n  const [selectedCfiRange, setSelectedCfiRange] = useState('')\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [filter, setFilter] = useState('all')\r\n  const [editingNote, setEditingNote] = useState(null)\r\n  const [settingsDrawerOpen, setSettingsDrawerOpen] = useState(false)\r\n  const [settings, setSettings] = useState(defaultSettings)\r\n  const [user, setUser] = useState(null)\r\n  const [isNote, setIsNote] = useState(false)\r\n  const [hasBookmark, setHasBookmark] = useState(false)\r\n  const [currentLocation, setCurrentLocation] = useState(null)\r\n  const [readStartTime, setReadStartTime] = useState(null)\r\n  const [bookmarkId, setBookmarkId] = useState(null)\r\n  const [lastReadingUpdate, setLastReadingUpdate] = useState(null)\r\n  const [isActive, setIsActive] = useState(true)\r\n  const [activeHighlights] = useState(new Set())\r\n\r\n  const startReadingSession = () => {\r\n    setReadStartTime(Date.now())\r\n  }\r\n\r\n  const updateReadingHistory = async () => {\r\n    const currentTime = Date.now()\r\n    const timeSpent = Math.floor((currentTime - lastReadingUpdate) / 1000)\r\n    if (!user || !bookId) return\r\n    try {\r\n      await axios.post(\r\n        `${process.env.REACT_APP_API_BASE_URL}/reading-history`,\r\n        {\r\n          userId: user.userId,\r\n          bookId: bookId,\r\n          timeSpent: timeSpent,\r\n        },\r\n        {\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        },\r\n      )\r\n      setLastReadingUpdate(currentTime)\r\n    } catch (error) {\r\n      console.error('Error updating reading history:', error)\r\n    }\r\n  }\r\n\r\n  const saveBookmark = async location => {\r\n    if (!user || !bookId) return\r\n\r\n    try {\r\n      await axios.post(\r\n        `${process.env.REACT_APP_API_BASE_URL}/bookmark`,\r\n        {\r\n          userId: user.userId,\r\n          bookId: bookId,\r\n          location: loca,\r\n        },\r\n        {\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        },\r\n      )\r\n      setHasBookmark(true)\r\n      toast.success('Đã lưu đánh dấu trang')\r\n    } catch (error) {\r\n      console.error('Error saving bookmark:', error)\r\n      toast.error('Có lỗi xảy ra khi lưu đánh dấu trang', 'error')\r\n    }\r\n  }\r\n\r\n  const getUser = async () => {\r\n    if (!localStorage.getItem('token')) return\r\n    try {\r\n      const response = await axios.get(\r\n        `${process.env.REACT_APP_API_BASE_URL}/user/profile`,\r\n        {\r\n          headers: {\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        },\r\n      )\r\n      setUser(response.data)\r\n    } catch (error) {\r\n      console.error(error)\r\n    }\r\n  }\r\n\r\n  const getNotes = async () => {\r\n    if (!user?.userId || !bookId || !rendition) return\r\n    try {\r\n      const response = await axios.get(\r\n        `${process.env.REACT_APP_API_BASE_URL}/note/user/${user.userId}/book/${bookId}`,\r\n        {\r\n          headers: {\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        },\r\n      )\r\n\r\n      const notesData = Array.isArray(response.data.data)\r\n        ? response.data.data\r\n        : []\r\n      setSelections(notesData)\r\n    } catch (error) {\r\n      console.error('Error fetching notes:', error)\r\n      setSelections([])\r\n    }\r\n  }\r\n\r\n  const handleEditNote = note => {\r\n    setEditingNote(note)\r\n  }\r\n\r\n  const handleSaveEdit = async () => {\r\n    try {\r\n      await axios.put(`${process.env.REACT_APP_API_BASE_URL}/note`, editingNote, {\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n        },\r\n      })\r\n\r\n      if (editingNote) {\r\n        setSelections(\r\n          selections.map(s =>\r\n            s.cfiRange === editingNote.cfiRange ? editingNote : s,\r\n          ),\r\n        )\r\n\r\n        // Xóa highlight cũ\r\n        rendition.annotations.remove(editingNote.cfiRange, 'highlight')\r\n        activeHighlights.delete(editingNote.cfiRange)\r\n\r\n        // Tạo highlight mới với màu đã cập nhật\r\n        rendition.annotations.add(\r\n          'highlight',\r\n          editingNote.cfiRange,\r\n          {},\r\n          null,\r\n          'hl',\r\n          {\r\n            fill: editingNote.color,\r\n            'fill-opacity': '0.3',\r\n            'mix-blend-mode': 'multiply',\r\n          },\r\n        )\r\n        activeHighlights.add(editingNote.cfiRange)\r\n\r\n        setIsNote(!isNote)\r\n        setEditingNote(null) // Đóng dialog\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating note:', error)\r\n    }\r\n  }\r\n\r\n  const getBookmark = async () => {\r\n    if (!user || !bookId) return\r\n    try {\r\n      const response = await axios.get(\r\n        `${process.env.REACT_APP_API_BASE_URL}/bookmark/user/${user.userId}/book/${bookId}`,\r\n        {\r\n          headers: {\r\n            Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n          },\r\n        },\r\n      )\r\n\r\n      if (response.data.data) {\r\n        setHasBookmark(true)\r\n        setBookmarkId(response.data.data.bookmarkId)\r\n        setLocation(response.data.data.location)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching bookmark:', error)\r\n    }\r\n  }\r\n\r\n  const handleToggleBookmark = async () => {\r\n    if (!user || !bookId) return\r\n\r\n    if (hasBookmark && bookmarkId) {\r\n      try {\r\n        await axios.put(\r\n          `${process.env.REACT_APP_API_BASE_URL}/bookmark`,\r\n          {\r\n            bookmarkId: bookmarkId,\r\n            userId: user.userId,\r\n            bookId: bookId,\r\n            location: loca,\r\n          },\r\n          {\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n              Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n            },\r\n          },\r\n        )\r\n        toast.success('Đã đánh dấu trang')\r\n      } catch (error) {\r\n        toast.error('Có lỗi xảy ra khi đánh dấu trang', 'error')\r\n      }\r\n    } else {\r\n      await saveBookmark(currentLocation)\r\n    }\r\n  }\r\n\r\n  const handleError = error => {\r\n    console.error('Error in ReactReader:', error)\r\n    setError(\r\n      'An error occurred while loading the book. Please try again later.',\r\n    )\r\n    setLoading(false)\r\n  }\r\n\r\n  const handleToggleDrawer = () => {\r\n    setDrawerOpen(!drawerOpen)\r\n  }\r\n\r\n  const handleSettingsDrawerToggle = () => {\r\n    setSettingsDrawerOpen(!settingsDrawerOpen)\r\n  }\r\n\r\n  const applySettings = () => {\r\n    if (rendition) {\r\n      // Xóa toàn bộ highlight hiện tại trước\r\n      activeHighlights.forEach(cfiRange => {\r\n        rendition.annotations.remove(cfiRange, 'highlight')\r\n      })\r\n      activeHighlights.clear()\r\n\r\n      // Apply settings mới\r\n      rendition.themes.default({\r\n        body: {\r\n          background: settings.theme,\r\n          color: settings.theme === '#121212' ? '#FFFFFF' : '#000000',\r\n          'font-family':\r\n            settings.fontFamily === 'Default' ? 'inherit' : settings.fontFamily,\r\n          'font-size': `${settings.fontSize}px`,\r\n          'font-weight': settings.fontWeight,\r\n          'line-height': settings.lineHeight,\r\n          transform: `scale(${settings.zoom / 100})`,\r\n          'transform-origin': 'top left',\r\n        },\r\n        'a, a:link, a:visited, a:hover, a:active': {\r\n          color: 'inherit !important',\r\n          '-webkit-text-fill-color': 'inherit !important',\r\n          'text-decoration': 'none',\r\n        },\r\n        '::selection': {\r\n          'background-color': 'rgba(0, 0, 255, 0.1)',\r\n          color: 'inherit',\r\n        },\r\n        '*': {\r\n          transition: 'none !important',\r\n        },\r\n      })\r\n\r\n      rendition.themes.select('default')\r\n\r\n      if (settings.pageView === 'double') {\r\n        rendition.spread('auto')\r\n      } else {\r\n        rendition.spread('none')\r\n      }\r\n\r\n      // Apply lại highlight sau khi settings đã được cập nhật\r\n      setTimeout(() => {\r\n        selections.forEach(note => {\r\n          rendition.annotations.add(\r\n            'highlight',\r\n            note.cfiRange,\r\n            {},\r\n            null,\r\n            'hl',\r\n            {\r\n              fill: note.color,\r\n              'fill-opacity': '0.3',\r\n              'mix-blend-mode': 'multiply',\r\n            },\r\n          )\r\n          activeHighlights.add(note.cfiRange)\r\n        })\r\n      }, 50)\r\n    }\r\n  }\r\n\r\n  const updateSettings = (key, value) => {\r\n    setSettings(prev => ({...prev, [key]: value}))\r\n\r\n    if (['fontSize', 'fontWeight', 'lineHeight', 'zoom'].includes(key)) {\r\n      rendition.clear()\r\n      rendition.themes.default({\r\n        body: {\r\n          background: settings.theme,\r\n          color: settings.theme === '#121212' ? '#FFFFFF' : '#000000',\r\n          'font-family': settings.fontFamily,\r\n          'font-size': `${value}px`,\r\n          'font-weight': key === 'fontWeight' ? value : settings.fontWeight,\r\n          'line-height': key === 'lineHeight' ? value : settings.lineHeight,\r\n          transform:\r\n            key === 'zoom'\r\n              ? `scale(${value / 100})`\r\n              : `scale(${settings.zoom / 100})`,\r\n          'transform-origin': 'top left',\r\n        },\r\n      })\r\n      rendition.display(loca)\r\n    }\r\n  }\r\n\r\n  const handleResetSettings = () => {\r\n    setSettings(defaultSettings)\r\n  }\r\n\r\n  // Event Listeners and Effect Hooks\r\n  useEffect(() => {\r\n    applySettings()\r\n  }, [settings])\r\n\r\n  useEffect(() => {\r\n    if (user?.userId && bookId) {\r\n      setLastReadingUpdate(Date.now())\r\n      setIsActive(true)\r\n\r\n      const intervalId = setInterval(() => {\r\n        if (isActive) {\r\n          updateReadingHistory()\r\n        }\r\n      }, 5 * 60 * 1000)\r\n\r\n      return () => {\r\n        updateReadingHistory()\r\n        clearInterval(intervalId)\r\n      }\r\n    }\r\n  }, [user, bookId])\r\n\r\n  useEffect(() => {\r\n    const handleVisibilityChange = () => {\r\n      if (document.hidden) {\r\n        setIsActive(false)\r\n        updateReadingHistory()\r\n      } else {\r\n        setIsActive(true)\r\n        setLastReadingUpdate(Date.now())\r\n      }\r\n    }\r\n\r\n    document.addEventListener('visibilitychange', handleVisibilityChange)\r\n    return () => {\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    const epubUrl = `https://www.gutenberg.org/cache/epub/${bookId}/pg${bookId}.epub`\r\n    setEpubUrl(epubUrl)\r\n    getUser()\r\n  }, [bookId])\r\n\r\n  useEffect(() => {\r\n    const handleBeforeUnload = () => {\r\n      updateReadingHistory()\r\n    }\r\n\r\n    window.addEventListener('beforeunload', handleBeforeUnload)\r\n    return () => {\r\n      window.removeEventListener('beforeunload', handleBeforeUnload)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (user && bookId) {\r\n      getBookmark()\r\n    }\r\n  }, [user && bookId])\r\n\r\n  useEffect(() => {\r\n    if (user && bookId) {\r\n      getNotes()\r\n    }\r\n  }, [user, bookId, rendition, isNote])\r\n\r\n  useEffect(() => {\r\n    if (rendition) {\r\n      const handleSelection = (cfiRange, contents) => {\r\n        const selection = contents.window.getSelection()\r\n        const text = selection.toString().trim() // Lấy text và trim luôn\r\n\r\n        // Chỉ xử lý khi có text thật sự\r\n        if (text) {\r\n          const range = selection.getRangeAt(0)\r\n          setSelectedText(text)\r\n          setSelectedCfiRange(cfiRange)\r\n\r\n          const rect = range.getBoundingClientRect()\r\n          const viewportHeight = window.innerHeight\r\n          const viewportWidth = window.innerWidth\r\n\r\n          setPopoverAnchor({\r\n            top:\r\n              rect.top < viewportHeight / 2\r\n                ? rect.bottom + window.scrollY + 115\r\n                : rect.top + window.scrollY - 60,\r\n            left: viewportWidth / 2 + 5,\r\n          })\r\n        }\r\n      }\r\n\r\n      rendition.on('selected', handleSelection)\r\n\r\n      rendition.themes.default({\r\n        '::selection': {\r\n          background: 'rgba(0, 0, 255, 0.1)',\r\n          color: 'inherit',\r\n        },\r\n        'a:link': {\r\n          color: 'inherit !important',\r\n          '-webkit-text-fill-color': 'inherit !important',\r\n        },\r\n        'a:hover': {\r\n          color: 'inherit !important',\r\n          '-webkit-text-fill-color': 'inherit !important',\r\n        },\r\n      })\r\n\r\n      return () => {\r\n        rendition.off('selected', handleSelection)\r\n      }\r\n    }\r\n  }, [rendition])\r\n\r\n  // Highlight Management\r\n  useEffect(() => {\r\n    if (rendition) {\r\n      const applyHighlight = note => {\r\n        if (!activeHighlights.has(note.cfiRange)) {\r\n          rendition.annotations.add(\r\n            'highlight',\r\n            note.cfiRange,\r\n            {},\r\n            null,\r\n            'hl',\r\n            {\r\n              fill: note.color,\r\n              'fill-opacity': '0.3',\r\n              'mix-blend-mode': 'multiply',\r\n              'white-space': 'pre-wrap', // Giữ nguyên khoảng trắng\r\n              'box-decoration-break': 'clone', // Đảm bảo highlight không vượt quá text\r\n            },\r\n          )\r\n          activeHighlights.add(note.cfiRange)\r\n        }\r\n      }\r\n\r\n      const removeHighlight = cfiRange => {\r\n        rendition.annotations.remove(cfiRange, 'highlight')\r\n        activeHighlights.delete(cfiRange)\r\n      }\r\n\r\n      const refreshHighlights = () => {\r\n        // Xóa những highlight không còn trong selections\r\n        for (const cfiRange of activeHighlights) {\r\n          if (!selections.some(note => note.cfiRange === cfiRange)) {\r\n            removeHighlight(cfiRange)\r\n          }\r\n        }\r\n\r\n        // Thêm những highlight mới\r\n        selections.forEach(note => {\r\n          if (!activeHighlights.has(note.cfiRange)) {\r\n            applyHighlight(note)\r\n          }\r\n        })\r\n      }\r\n\r\n      refreshHighlights()\r\n\r\n      // Handler cho việc di chuyển trang\r\n      const handleRelocated = () => {\r\n        selections.forEach(note => {\r\n          if (!activeHighlights.has(note.cfiRange)) {\r\n            applyHighlight(note)\r\n          }\r\n        })\r\n      }\r\n\r\n      rendition.on('relocated', handleRelocated)\r\n\r\n      return () => {\r\n        rendition.off('relocated', handleRelocated)\r\n        // Không xóa highlights khi unmount để tránh việc phải render lại\r\n      }\r\n    }\r\n  }, [rendition, selections])\r\n\r\n  const handleSave = async () => {\r\n    if (selectedCfiRange) {\r\n      const newNote = {\r\n        userId: user.userId,\r\n        bookId: bookId,\r\n        content: comment || '',\r\n        selectedText: selectedText,\r\n        cfiRange: selectedCfiRange,\r\n        color: highlightColor,\r\n      }\r\n\r\n      try {\r\n        const response = await axios.post(\r\n          `${process.env.REACT_APP_API_BASE_URL}/note`,\r\n          newNote,\r\n          {\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n              Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n            },\r\n          },\r\n        )\r\n\r\n        const createdNote = response.data\r\n        setSelections(prev => [...prev, createdNote])\r\n        setPopoverAnchor(null)\r\n        setComment('')\r\n        setSelectedText('')\r\n        setSelectedCfiRange('')\r\n        setIsNote(!isNote)\r\n      } catch (error) {\r\n        console.error('Error creating note:', error)\r\n      }\r\n    }\r\n  }\r\n\r\n  const handleRemoveHighlight = async (cfiRange, noteId) => {\r\n    try {\r\n      await axios.delete(`${process.env.REACT_APP_API_BASE_URL}/note/${noteId}`, {\r\n        headers: {\r\n          Authorization: `Bearer ${localStorage.getItem('token')}`,\r\n        },\r\n      })\r\n\r\n      // Xóa highlight cụ thể\r\n      rendition.annotations.remove(cfiRange, 'highlight')\r\n      activeHighlights.delete(cfiRange)\r\n\r\n      // Cập nhật state\r\n      setSelections(selections.filter(s => s.cfiRange !== cfiRange))\r\n    } catch (error) {\r\n      console.error('Error deleting note:', error)\r\n    }\r\n  }\r\n\r\n  const filteredSelections = Array.isArray(selections)\r\n    ? selections\r\n        .filter(selection => {\r\n          const isTextMatch =\r\n            (selection.selectedText\r\n              ?.toLowerCase()\r\n              .includes(searchTerm.toLowerCase()) ??\r\n              false) ||\r\n            (selection.content\r\n              ?.toLowerCase()\r\n              .includes(searchTerm.toLowerCase()) ??\r\n              false)\r\n          const isColorMatch = filter === 'all' || selection.color === filter\r\n          return isTextMatch && isColorMatch\r\n        })\r\n        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))\r\n    : []\r\n\r\n  const readerStyles = {\r\n    ...ReactReaderStyle,\r\n    readerArea: {\r\n      ...ReactReaderStyle.readerArea,\r\n      backgroundColor: settings.theme,\r\n      color: settings.theme === '#121212' ? '#FFFFFF' : '#000000',\r\n    },\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className='App'\r\n      style={{height: '100vh', display: 'flex', flexDirection: 'column'}}>\r\n      <ReaderHeader\r\n        title={bookTitle}\r\n        onBack={() => navigate(-1)}\r\n        onToggleNotes={handleToggleDrawer}\r\n        onToggleSettings={handleSettingsDrawerToggle}\r\n        user={user}\r\n        onToggleBookmark={handleToggleBookmark}\r\n        hasBookmark={hasBookmark}\r\n        currentLocation={currentLocation}\r\n      />\r\n\r\n      {loading && <p>Loading...</p>}\r\n      {error && <p style={{color: 'red'}}>{error}</p>}\r\n\r\n      <ReaderContent\r\n        epubUrl={epubUrl}\r\n        location={loca}\r\n        onLocationChanged={loc => setLocation(loc)}\r\n        onGetRendition={_rendition => {\r\n          setRendition(_rendition)\r\n\r\n          // Apply default settings ngay khi rendition được tạo\r\n          _rendition.themes.default({\r\n            body: {\r\n              background: defaultSettings.theme,\r\n              color:\r\n                defaultSettings.theme === '#121212' ? '#FFFFFF' : '#000000',\r\n              'font-family': defaultSettings.fontFamily,\r\n              'font-size': `${defaultSettings.fontSize}px`,\r\n              'font-weight': defaultSettings.fontWeight,\r\n              'line-height': defaultSettings.lineHeight,\r\n              transform: `scale(${defaultSettings.zoom / 100})`,\r\n              'transform-origin': 'top left',\r\n            },\r\n            'a, a:link, a:visited, a:hover, a:active': {\r\n              color: 'inherit !important',\r\n              '-webkit-text-fill-color': 'inherit !important',\r\n              'text-decoration': 'none',\r\n            },\r\n            '::selection': {\r\n              'background-color': 'rgba(0, 0, 255, 0.1)',\r\n              color: 'inherit',\r\n            },\r\n            '*': {\r\n              transition: 'none !important',\r\n            },\r\n          })\r\n\r\n          _rendition.themes.select('default')\r\n\r\n          if (defaultSettings.pageView === 'double') {\r\n            _rendition.spread('auto')\r\n          } else {\r\n            _rendition.spread('none')\r\n          }\r\n\r\n          _rendition.on('started', () => setLoading(false))\r\n        }}\r\n        onError={handleError}\r\n        readerStyles={readerStyles}\r\n      />\r\n      <NotePopover\r\n        anchorPosition={popoverAnchor}\r\n        open={Boolean(popoverAnchor)}\r\n        onClose={() => setPopoverAnchor(null)}\r\n        colors={colors}\r\n        highlightColor={highlightColor}\r\n        setHighlightColor={setHighlightColor}\r\n        comment={comment}\r\n        setComment={setComment}\r\n        onSave={handleSave}\r\n      />\r\n\r\n      <NotesDrawer\r\n        open={drawerOpen}\r\n        onClose={handleToggleDrawer}\r\n        searchTerm={searchTerm}\r\n        setSearchTerm={setSearchTerm}\r\n        filter={filter}\r\n        setFilter={setFilter}\r\n        colors={colors}\r\n        filteredSelections={filteredSelections}\r\n        rendition={rendition}\r\n        onRemoveHighlight={handleRemoveHighlight}\r\n        onEditNote={handleEditNote}\r\n      />\r\n\r\n      <Dialog open={Boolean(editingNote)} onClose={() => setEditingNote(null)}>\r\n        <DialogTitle>Edit Note</DialogTitle>\r\n        <DialogContent>\r\n          <TextField\r\n            autoFocus\r\n            margin='dense'\r\n            label='Comment'\r\n            fullWidth\r\n            multiline\r\n            rows={4}\r\n            value={editingNote?.content || ''}\r\n            onChange={e =>\r\n              setEditingNote({...editingNote, content: e.target.value})\r\n            }\r\n          />\r\n          <Select\r\n            value={editingNote?.color || colors[0]}\r\n            onChange={e =>\r\n              setEditingNote({...editingNote, color: e.target.value})\r\n            }\r\n            fullWidth\r\n            style={{marginTop: '10px'}}>\r\n            {colors.map((color, index) => (\r\n              <MenuItem key={index} value={color}>\r\n                <span\r\n                  style={{\r\n                    backgroundColor: color,\r\n                    padding: '2px 10px',\r\n                    borderRadius: '5px',\r\n                    color: color,\r\n                  }}>\r\n                  {`ColorColorColorColorColorColori`}\r\n                </span>\r\n              </MenuItem>\r\n            ))}\r\n          </Select>\r\n        </DialogContent>\r\n        <DialogActions>\r\n          <Button onClick={() => setEditingNote(null)}>Cancel</Button>\r\n          <Button\r\n            color='primary'\r\n            variant='contained'\r\n            disabled={\r\n              !editingNote ||\r\n              (selections.find(note => note.noteId === editingNote.noteId)\r\n                ?.content === editingNote.content &&\r\n                selections.find(note => note.noteId === editingNote.noteId)\r\n                  ?.color === editingNote.color)\r\n            }\r\n            onClick={handleSaveEdit}>\r\n            Save\r\n          </Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n\r\n      <SettingsDrawer\r\n        open={settingsDrawerOpen}\r\n        onClose={handleSettingsDrawerToggle}\r\n        settings={settings}\r\n        updateSettings={updateSettings}\r\n        themes={themes}\r\n        fontFamilies={fontFamilies}\r\n        onResetSettings={handleResetSettings}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default ReadBookScreen\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}